var currentWin = Ti.UI.currentWindow;
var Cloud = require('ti.cloud');
var dataB = Ti.Database.open("UserDB");
dataB.execute("CREATE TABLE IF NOT EXISTS user(id INTEGER PRIMARY KEY, firstname TEXT, lastname TEXT)");

var holder = Ti.UI.createScrollView({
	backgroundColor: "red",
	top: 100,
	bottom: 0,
	width: Ti.FILL,
	layout: "horizontal",
	contentWidth: Ti.Platform.displayCaps.platformWidth
});


////////////////////////////////////// Prompt //////////////////////////////////////
var promptHolder = Ti.UI.createView({
	width: Ti.UI.FIIL,
	height: Ti.UI.FILL,
	backgroundColor: "black",
	opacity: 0.8
});
var prompt = Ti.UI.createView({
	backgroundColor: "#FFF",
	width: 200,
	height: 100,
	borderRadius: 20
});

//Create button
var button1 = Ti.UI.createButton({
	title: "yes",
	left: 20,
	bottom: 20
});

//Cancel (closes the prompt)
var button3 = Ti.UI.createButton({
	title: "no",
	right: 20,
	bottom: 20
});
var label = Ti.UI.createLabel({
	text: "Would you like to save this user?",
	font: {fontSize: 14},
	top: 20
});

prompt.add(button1); 
prompt.add(button3); 
prompt.add(label);
prompt.visible = false;
promptHolder.visible = false;
////////////////////////////////////// Prompt //////////////////////////////////////


Cloud.Users.query({
    page: 1,
    per_page: 10,
}, function (e) {
    if (e.success) {
        alert('Success:\n' +
            'Count: ' + e.users.length);
        for (var i = 0; i < e.users.length; i++) {
            var user = e.users[i];
            var label = Ti.UI.createLabel({
            	text: user.first_name + " " + user.last_name,
            	color: "#000"
            });	
            var row = Ti.UI.createView({
            	backgroundColor: "#FFF",
            	height: "20%",
            	left: 40,	
            	right: 40
            });
            var image = Ti.UI.createImageView({
            	image: "http://dogvacay.com/img/default_profile.jpg",
            	backgroundColor: "#000",
            	height: "80%",
            	left: 10,
            	width: "35%"
            });
            row.add(image);
            row.add(label);
            holder.add(row);
            
            // alert('id: ' + user.id + '\n' +
                // 'first name: ' + user.first_name + '\n' +
                // 'last name: ' + user.last_name);
         }
    } else {
        alert('Error:\n' +
            ((e.error && e.message) || JSON.stringify(e)));
    }
});

var buildRow = function () {
	var data = [];
	var test = dataB.execute("SELECT * FROM user");
	
	while (test.isValidRow()) {
		var firstname = test.fieldByName('firstname');
		var lastname = test.fieldByName('lastname');
		var id = test.fieldByName('id');

		data.push({
			firstname : name,
			lastname : state,
			title : firstname + " " + lastname,
			id : id
		});
		test.next();
	};
	return data;
};

var table = Ti.UI.createTableView();
table.setData(buildRow());
row.addEventListener("click", function(e){
	prompt.visible = true;
	promptHolder.visible = true;

	button1.addEventListener('click', function(){
		dataB.execute("INSERT INTO user(firstname,lastname) VALUES (?,?)", name, st, county, latitude, longitude, dist, pop);
		alert(name + " has been added to your favorites list");
	});
	

	
});


currentWin.add(holder);
//currentWin.add(cam);